<!DOCTYPE html>
<html>
<head>
  <title>Phone Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      touch-action: none; /* Prevent default touch actions */
    }
    
    .joystick-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 20px;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      touch-action: none;
    }
    
    .joystick-base {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid #888;
      box-sizing: border-box;
    }
    
    .joystick-thumb {
      position: absolute;
      width: 80px;
      height: 80px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: #3498db;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }
    
    .client-info {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 5px;
      font-size: 14px;
      color: #333;
    }
    
    .status-connected {
      color: green;
      font-weight: bold;
    }
    
    .status-disconnected {
      color: red;
      font-weight: bold;
    }
    
    .debug-info {
      margin-top: 20px;
      font-size: 12px;
      color: #666;
    }
    
    .joystick-position {
      margin-top: 10px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Vector Joystick Controller</h1>
  <div class="client-info" id="clientInfo">Connecting...</div>
  
  <div class="joystick-container" id="joystickArea">
    <div class="joystick-base"></div>
    <div class="joystick-thumb" id="joystick"></div>
  </div>
  
  <div class="joystick-position" id="joystickPosition">x: 0.00, y: 0.00</div>
  <div class="debug-info" id="debugInfo"></div>
  
  <script>
    const socket = io();
    let clientId = null;
    let eventLog = [];
    const maxLogEntries = 5;
    
    // Joystick variables
    const joystickThumb = document.getElementById('joystick');
    const joystickArea = document.getElementById('joystickArea');
    const joystickPosition = document.getElementById('joystickPosition');
    let isDragging = false;
    let centerX, centerY;
    let currentX = 0, currentY = 0;
    let joystickInterval = null;
    
    // Initialize joystick positions
    function initJoystick() {
      const rect = joystickArea.getBoundingClientRect();
      centerX = rect.width / 2;
      centerY = rect.height / 2;
      joystickThumb.style.left = centerX + 'px';
      joystickThumb.style.top = centerY + 'px';
    }
    
    // Setup joystick touch events
    function setupJoystick() {
      // Mouse events
      joystickThumb.addEventListener('mousedown', startMoveJoystick);
      document.addEventListener('mousemove', moveJoystick);
      document.addEventListener('mouseup', stopMoveJoystick);
      
      // Touch events for mobile
      joystickThumb.addEventListener('touchstart', startMoveJoystick);
      document.addEventListener('touchmove', moveJoystick);
      document.addEventListener('touchend', stopMoveJoystick);
      
      initJoystick();
    }
    
    // Start moving the joystick
    function startMoveJoystick(e) {
      e.preventDefault();
      isDragging = true;
      
      // Send inputs at a fixed interval while joystick is active
      if (joystickInterval === null) {
        joystickInterval = setInterval(sendJoystickVector, 100); // Send every 100ms
      }
    }
    
    // Move the joystick
    function moveJoystick(e) {
      if (!isDragging) return;
      e.preventDefault();
      
      const rect = joystickArea.getBoundingClientRect();
      
      // Get touch/mouse position
      let clientX, clientY;
      if (e.type.startsWith('touch')) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      
      // Calculate position relative to joystick area
      let x = clientX - rect.left;
      let y = clientY - rect.top;
      
      // Calculate distance from center
      const dx = x - centerX;
      const dy = y - centerY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const maxDistance = rect.width / 2 - joystickThumb.offsetWidth / 2;
      
      // If distance is greater than max, normalize to max
      if (distance > maxDistance) {
        x = centerX + (dx / distance) * maxDistance;
        y = centerY + (dy / distance) * maxDistance;
      }
      
      // Update joystick position
      joystickThumb.style.left = x + 'px';
      joystickThumb.style.top = y + 'px';
      
      // Calculate normalized vector (-1 to 1 on both axes)
      currentX = (x - centerX) / maxDistance;
      currentY = (y - centerY) / maxDistance;
      
      // Update position display
      updatePositionDisplay();
    }
    
    // Stop moving the joystick
    function stopMoveJoystick(e) {
      if (!isDragging) return;
      e.preventDefault();
      isDragging = false;
      
      // Return joystick to center
      joystickThumb.style.left = centerX + 'px';
      joystickThumb.style.top = centerY + 'px';
      
      // Reset vector
      currentX = 0;
      currentY = 0;
      updatePositionDisplay();
      
      // Clear the interval
      if (joystickInterval !== null) {
        clearInterval(joystickInterval);
        joystickInterval = null;
      }
      
      // Send zero vector
      sendJoystickVector();
    }
    
    // Update the position display
    function updatePositionDisplay() {
      joystickPosition.textContent = `x: ${currentX.toFixed(2)}, y: ${currentY.toFixed(2)}`;
    }
    
    // Send the current joystick vector
    function sendJoystickVector() {
      sendInput({
        type: "vector",
        x: currentX,
        y: currentY
      });
    }
    
    // Debug function to log events
    function logEvent(event) {
      const timestamp = new Date().toLocaleTimeString();
      eventLog.unshift(`${timestamp}: ${event}`);
      if (eventLog.length > maxLogEntries) {
        eventLog.pop();
      }
      
      document.getElementById('debugInfo').innerHTML = eventLog.join('<br>');
    }
    
    // Update client info element
    function updateClientInfo() {
      const infoElement = document.getElementById('clientInfo');
      if (clientId) {
        infoElement.innerHTML = `Status: <span class="status-connected">Connected</span><br>ID: ${clientId}`;
      } else {
        infoElement.innerHTML = `Status: <span class="status-disconnected">Disconnected</span>`;
      }
    }
    
    // Receive client ID from server
    socket.on('clientId', (data) => {
      clientId = data.id;
      updateClientInfo();
      logEvent(`Connected with ID: ${clientId}`);
      
      // Send a test connection to make sure Unity registers us
      socket.emit("controllerInput", { action: "CONNECT" });
    });

    function sendInput(data) {
      if (!clientId) {
        logEvent('Cannot send input - not connected');
        return;
      }
      
      socket.emit("controllerInput", data);
      
      // Only log vector messages occasionally to avoid flooding
      if (data.type === "vector" && Math.random() < 0.1) {
        logEvent(`Sent: (${data.x.toFixed(2)}, ${data.y.toFixed(2)})`);
      }
    }
    
    // Handle connection events
    socket.on('connect', () => {
      logEvent('Socket connected');
      updateClientInfo();
    });
    
    socket.on('disconnect', () => {
      clientId = null;
      updateClientInfo();
      logEvent('Socket disconnected');
    });
    
    socket.on('connect_error', (error) => {
      logEvent(`Connection error: ${error.message}`);
    });
    
    socket.on('reconnect_attempt', (attemptNumber) => {
      logEvent(`Reconnect attempt: ${attemptNumber}`);
    });
    
    socket.on('reconnect', (attemptNumber) => {
      logEvent(`Reconnected after ${attemptNumber} attempts`);
    });
    
    // Initialize joystick when page loads
    window.addEventListener('load', () => {
      setupJoystick();
      logEvent('Controller page loaded');
    });
  </script>
</body>
</html>
